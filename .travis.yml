language: rust
sudo: false

rust:
  - nightly

branches:
  only:
    # release tags
    - /^v\d+\.\d+\.\d+.*$/
    - master

env:
  global:
    # - Create a crates_io token. Go to: https://crates.io/me/new
    # - Encrypt it: `travis encrypt "CRATES_IO_TOKEN=0123456789012345678901234567890123456789"
    # - Paste the output here
    secure: "OvsiZjLf4HdxRAtd3VEPE2mQdZIqhNMdIa0JhGPS6s/JRSS7WmdNhs+PzdK8BTXg8OqWhpx0mP2dqqItibXy8bA1iuGwP03SomasrfiEWNC9OaFLaU/A0JTl/hEEOC37Va9QElG6XThb1os2aY2o1PZ76cc+NlcV9hiwavdpKZfT5zaW30GrtNF2It1agx1T2SRGPdy/tTZBBo/bEhf3+VF+bDk4z4/lqja3RTLq0KdZouXQAaw12vSiEPOcmli/VOQZa0kEPqk2mAktV6vE99Qt3Mcj2k2azQYKOeoxfzjh3qpoPyD9O0jxcW+penJG4NVPslmzwvwSEl5ZIGuuFSgk+1O9+qFsmvFF5Z1c4GZJW6EuRX1g9lxlbVvAMk9j1cpfXNB90OuEhliMo5mCtPGAxVn4WYzliC1hudxEonz5dOX4NIiFsDJet8QubwWw+DoVBF8sX35UEq5D9sEY2jF6JSN3EIkJFepdPJ0Z2Q+CGvqepik5S1Fq9srLLEmVAqeyuGlZn9DxY+WNOFX0nMJvfcpO5DZKN13fsfBUQhHUGCr73ZEVVabr0YSWFIbc9J2i/DwLpIpTNbpklEERGIOsXEl1mPBTC4YGtrHgVO+kf2HY/eDm/c8pHIhbXpDXy2w7HV3CIjIqTjnmqyeUkKTqYCuT9VU5cSYfg/ZtH0g="

before_script:
  - pip install 'travis-cargo<0.2' --user && export PATH=$HOME/.local/bin:$PATH

script:
  - cargo test
  - rustdoc --test README.md -L target
  - cargo doc --no-deps || echo "skipping cargo doc"

before_deploy:
  - cargo doc
  - cargo package

# This deploy action will only be run if a tag is set on the master branch.
deploy:
  provider: releases
  # - Create a `public_repo` GitHub token. Go to: https://github.com/settings/tokens/new
  # - Encrypt it: `travis encrypt 0123456789012345678901234567890123456789
  # - Paste the output down here
  api_key:
    secure: "IDm3Oc3bmIL4/6zixovwkuTkbinqWnKdLfeuKTtHqT4ZbVy+rxTDQBgLGfVngymjciHWkJnvQ8/2nT3/KW4MPNY9Sqt3NfWvO7vj9cXypeNeJ4xFrVK49F7CMM4KTCeSMlDKR1C0TVYGgxFIViLtBw/imivl9fk6J489eKv36sA="
  file: target/package/Molten-$TRAVIS_TAG.crate
  skip_cleanup: true
  on:
    tags: true
    branch: master
    condition: "$TRAVIS_RUST_VERSION = nightly"

after_deploy:
  # Publish updated documentation
  - travis-cargo --only nightly doc-upload
  # Publish updated coverage data
  - travis-cargo coveralls --no-sudo
  # Publish new crate to crates.io
  - |
     [ $TRAVIS_RUST_VERSION = nightly ] &&
     [ $TRAVIS_BRANCH = master ] &&
     [ $TRAVIS_PULL_REQUEST = false ] &&
     cargo publish --token ${CRATES_IO_TOKEN}

addons:
  apt:
    packages:
      - libcurl4-openssl-dev
      - libelf-dev
      - libdw-dev

cache: cargo

before_cache:
  # Travis can't cache files that are not readable by "others"
  - chmod -R a+r $HOME/.cargo

notifications:
  email:
    on_success: never
